<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <meta name="description" content="Aplicación para seguir el progreso de lectura bíblica personal.">

  <title>Mi Progreso Bíblico</title>

  <link rel="stylesheet" href="style.css">

  <link rel="manifest" href="manifest.json">

  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="Progreso Bíblico">

  <link rel="icon" href="icons/icon-192x192.png" type="image/png">
  <link rel="apple-touch-icon" href="icons/icon-192x192.png">

</head>
<body>
  <script>
    // Aplicación de tema (se mantiene igual)
    function applyCustomTheme(primary, accent) {
      document.documentElement.style.setProperty('--primary-color', primary);
      document.documentElement.style.setProperty('--accent-color', accent);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const primaryPicker = document.getElementById('primaryColorPicker');
      const accentPicker = document.getElementById('accentColorPicker');
      const defaultPrimaryColor = '#0A2342';
      const defaultAccentColor = '#F4B942';
      const savedPrimary = localStorage.getItem('theme-primary');
      const savedAccent = localStorage.getItem('theme-accent');

      if (savedPrimary && savedAccent) {
        applyCustomTheme(savedPrimary, savedAccent);
        if(primaryPicker) primaryPicker.value = savedPrimary;
        if(accentPicker) accentPicker.value = savedAccent;
      } else {
        applyCustomTheme(defaultPrimaryColor, defaultAccentColor);
        if(primaryPicker) primaryPicker.value = defaultPrimaryColor;
        if(accentPicker) accentPicker.value = defaultAccentColor;
      }

      const saveThemeButton = document.getElementById('saveThemeButton');
      if(saveThemeButton) {
        saveThemeButton.addEventListener('click', () => {
          const primary = primaryPicker.value;
          const accent = accentPicker.value;
          applyCustomTheme(primary, accent);
          localStorage.setItem('theme-primary', primary);
          localStorage.setItem('theme-accent', accent);
        });
      }

      const resetThemeButton = document.getElementById('resetThemeButton');
      if(resetThemeButton) {
        resetThemeButton.addEventListener('click', () => {
          applyCustomTheme(defaultPrimaryColor, defaultAccentColor);
          if(primaryPicker) primaryPicker.value = defaultPrimaryColor;
          if(accentPicker) accentPicker.value = defaultAccentColor;
          localStorage.removeItem('theme-primary');
          localStorage.removeItem('theme-accent');
        });
      }
      
      document.querySelectorAll('.theme-preset').forEach(btn => {
        btn.addEventListener('click', () => {
          const primary = btn.getAttribute('data-primary');
          const accent = btn.getAttribute('data-accent');
          applyCustomTheme(primary, accent);
          if(primaryPicker) primaryPicker.value = primary;
          if(accentPicker) accentPicker.value = accent;
          localStorage.setItem('theme-primary', primary);
          localStorage.setItem('theme-accent', accent);
        });
      });
    });
  </script>

  <div class="container">
    <header>
      <h1>Lectura Bíblica</h1>

      <div class="daily-suggestion">
        <div class="suggestion-block suggestion-block--date">
          <h3 class="suggestion-block__title">Fecha Actual</h3>
          <p class="daily-suggestion__date" id="currentDateText">[La fecha se cargará aquí]</p>
        </div>
      
        <div class="suggestion-block suggestion-block--reading">
          <h3 class="suggestion-block__title">Lectura Sugerida</h3>
          <div id="suggestedReadingContentContainer" class="suggested-reading-content">
            <p class="daily-suggestion__text" id="dailySuggestionMainText" aria-live="polite">Cargando sugerencia...</p>
            <a class="daily-suggestion__link suggested-reading__link" id="dailySuggestionOnlineLink" href="#" target="_blank" style="display: none;" aria-label="Abrir lectura sugerida">Ver lectura online</a>
            <small id="jwAppSuggestionNote" style="display:none; margin-top: calc(var(--spacing) * 0.5); font-style: italic; color: var(--text-light-color);"></small>
          </div>
          <div class="suggestion-block__actions">
              <button type="button" class="daily-suggestion__button" id="markSuggestedAsReadButton" style="display: none;">Marcar como Leído</button>
              <button type="button" class="daily-suggestion__button" id="addToCalendarButton" style="display: none;">Añadir al Calendario</button>
          </div>
        </div>
      
        <div class="suggestion-block suggestion-block--status">
          <h3 class="suggestion-block__title">Estado del Plan</h3>
          <p class="daily-suggestion__delay-indicator">
            Días de retraso: <span id="daysDelayedText" aria-live="polite">0</span>
          </p>
        </div>
      </div>

      <div class="progress-container">
        <div class="progress-bar-overall" role="progressbar" aria-labelledby="progressText" aria-valuenow="0" aria-valuemin="0" aria-valuemax="100">
          <div id="progressBar"></div>
        </div>
        <span id="progressText" aria-live="polite">0%</span>
      </div>
    </header>

    <section id="plan-management">
      <h2>Gestionar Plan de Lectura</h2>
      <div class="field-group">
        <label for="planStartDateInput">Fecha de inicio del plan:</label>
        <input type="date" id="planStartDateInput">
        <button type="button" id="setPlanStartDateButton">Establecer Inicio</button>
        <p id="currentPlanStartDateText" aria-live="polite">Cargando fecha de inicio...</p>
      </div>
      <div class="field-group">
        <label for="syncReadingSelect">Sincronizar plan:</label>
        <select id="syncReadingSelect">
          <option value="">Cargando lecturas del plan...</option>
        </select>
        <button type="button" id="syncPlanButton">Sincronizar Plan</button>
      </div>
    </section>

    <section id="thematic-reading-goals">
      <h2>Metas de Lectura Temática</h2>
      <div id="thematicSectionsContainer" class="thematic-sections-grid">
          </div>
    </section>

    <section id="theme-customizer">
      <h2>Personaliza los Colores</h2>
      <div class="field-group">
        <label for="primaryColorPicker">Color principal:</label>
        <input type="color" id="primaryColorPicker" value="#0A2342" title="Selector de color principal">
        
        <label for="accentColorPicker">Color de acento:</label>
        <input type="color" id="accentColorPicker" value="#F4B942" title="Selector de color de acento">
        
        <button type="button" id="saveThemeButton">Guardar Estilo</button>
        <button type="button" id="resetThemeButton">Restaurar Colores por Defecto</button>
      </div>

      <div class="field-group">
        <label>O elige una paleta predefinida:</label>
        <div id="presetThemes" class="suggestion-block__actions">
          <button type="button" class="theme-preset daily-suggestion__button" data-primary="#0A2342" data-accent="#F4B942" style="background:#0A2342; color:#F4B942;">Abismo</button>
          <button type="button" class="theme-preset daily-suggestion__button" data-primary="#0b3d91" data-accent="#f39c12" style="background:#0b3d91; color:#f39c12;">Clásico</button>
          <button type="button" class="theme-preset daily-suggestion__button" data-primary="#2c3e50" data-accent="#e67e22" style="background:#2c3e50; color:#e67e22;">Oscuro</button>
          <button type="button" class="theme-preset daily-suggestion__button" data-primary="#16a085" data-accent="#f1c40f" style="background:#16a085; color:#f1c40f;">Tropical</button>
          <button type="button" class="theme-preset daily-suggestion__button" data-primary="#8e44ad" data-accent="#3498db" style="background:#8e44ad; color:#3498db;">Vibrante</button>
        </div>
      </div>
    </section>

    <section id="controls">
      <h2>Filtros y Controles</h2>
      <div class="field-group">
        <label for="bookFilter">Filtrar por Libro:</label>
        <select id="bookFilter">
          <option value="todos">Todos los Libros</option>
        </select>
      </div>
      <div class="field-group">
        <label for="statusFilter">Filtrar por Estado:</label>
        <select id="statusFilter">
          <option value="todos">Todos</option>
          <option value="leidos">Leídos</option>
          <option value="no_leidos">No Leídos</option>
        </select>
      </div>
      <button type="button" id="resetProgress">Reiniciar Progreso</button>
    </section>

    <main id="bibleBooksContainer">
      </main>

    <footer>
      <p>&copy; <span id="currentYearText"></span> FabricaDev</p>
    </footer>
  </div>

  <script src="./script.js" defer></script>

  <script>
    // Función para descargar ICS (se mantiene igual)
    function downloadICS({ title, description, startDate, endDate }) {
      function fmt(d) {
        const y = d.getFullYear(),
              m = String(d.getMonth() + 1).padStart(2, '0'),
              dd = String(d.getDate()).padStart(2, '0');
        return `${y}${m}${dd}`;
      }
      const dtStart = fmt(startDate),
            dtEnd = fmt(endDate),
            now = new Date(),
            dtStamp = `${now.getUTCFullYear()}${String(now.getUTCMonth() + 1).padStart(2, '0')}${String(now.getUTCDate()).padStart(2, '0')}T${String(now.getUTCHours()).padStart(2, '0')}${String(now.getUTCMinutes()).padStart(2, '0')}${String(now.getUTCSeconds()).padStart(2, '0')}Z`;

      const lines = [
              'BEGIN:VCALENDAR', 'VERSION:2.0', 'PRODID:-//TuApp//LecturaDiaria//ES',
              'BEGIN:VEVENT', `UID:${Date.now()}@tubiblia.app`, `DTSTAMP:${dtStamp}`,
              `DTSTART;VALUE=DATE:${dtStart}`, `DTEND;VALUE=DATE:${dtEnd}`, `SUMMARY:${title}`,
              `DESCRIPTION:${description.replace(/\n/g, '\\n')}`, 'END:VEVENT', 'END:VCALENDAR'
            ];
      const blob = new Blob([lines.join('\r\n')], { type: 'text/calendar;charset=utf-8' }),
            url = URL.createObjectURL(blob), a = document.createElement('a');
      a.href = url; a.download = `${title.replace(/[^\w\s.-]/gi, '').replace(/\s+/g, '_')}.ics`;
      document.body.appendChild(a); a.click(); document.body.removeChild(a); URL.revokeObjectURL(url);
    }

    document.addEventListener('DOMContentLoaded', () => {
      const currentYearEl = document.getElementById('currentYearText');
      if (currentYearEl) {
        currentYearEl.textContent = new Date().toLocaleDateString('es-ES', { year: 'numeric', timeZone: 'Europe/Madrid' });
      }
      
    });
  </script>

  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker
          .register('./sw.js')
          .then(reg => console.log('Service Worker: Registrado con éxito. Scope:', reg.scope))
          .catch(err => console.error('Service Worker: Error de Registro:', err));
      });
    }
  </script>
</body>
</html>
